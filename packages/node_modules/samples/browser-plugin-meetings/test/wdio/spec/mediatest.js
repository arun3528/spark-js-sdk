/* globals browser */
import {expect} from 'chai';

import testUsers from '@webex/test-helper-test-users';

describe('samples', () => {
  describe('browser-plugin-meetings', () => {
    describe('normal dialing', () => {
      let spock, mccoy;

      const browserSpock = browser.select('browserSpock');
      const browserMccoy = browser.select('browserMccoy');

      before('create test users', () => testUsers.create({count: 2})
        .then((users) => {
          [spock, mccoy] = users;
          console.log('ACCESS TOKEN ', users);
        }));

      before('reload browser', () => {
        browser.refresh();
      });

      it('loads the app', () => {
        browser.url('/browser-plugin-meetings');
        browser.waitForExist('#access-token', 1500);
      });

      it('connects mccoy\'s browser', () => {
        expect(browserMccoy.getTitle()).to.equal('Sample: Meetings Kitchen Sink');
        browserMccoy.setValue('#access-token', mccoy.token.access_token);
        browserMccoy.click('#connect');
      });

      it('connects spock\'s browser', () => {
        expect(browserSpock.getTitle()).to.equal('Sample: Meetings Kitchen Sink');
        browserSpock.setValue('#access-token', spock.token.access_token);
        browserSpock.click('#connect');
      });

      it('places call from mccoy to spock', () => {
        browserSpock.setValue('#invitee', mccoy.emailAddress);
        browserSpock.click('[title="create"]');
        browserSpock.pause(1500);
        browserSpock.click('#join');
        browserSpock.pause(1500);
        browserSpock.click('#addMedia');
      });

      it('mccoy answers the call', () => {
        browserMccoy.waitForVisible('#answer', 20000);
        browserMccoy.click('#answer');
        browserMccoy.waitForVisible('#addMedia', 20000);
        browserMccoy.click('#addMedia');
        browserMccoy.waitForVisible('#remotevideo', 20000);
        browserMccoy.waitForVisible('#stop-sending-audio', 20000);
        browserMccoy.click('#stop-sending-audio');
        browserSpock.waitForVisible('#stop-sending-audio', 20000);
        browserSpock.click('#stop-sending-audio');
      });

      it('ends the call', () => {
        browser.click('#leave');
      });
    });
  });
});
